<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Consulta de Preço</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #005A9C; --success-color: #198754; --secondary-color: #6c757d;
            --background-color: #f4f6f9; --text-color: #333; --card-bg-color: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.08); --border-color: #dee2e6;
        }
        body { background-color: var(--background-color); font-family: 'Poppins', sans-serif; color: var(--text-color); }
        .main-container {
            background-color: var(--card-bg-color); border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color); padding: 2rem;
            margin: 2rem 0; width: 100%; max-width: 1200px;
        }
        .page-title { color: var(--primary-color); font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.75rem; }
        .btn-success { background-color: var(--success-color); border-color: var(--success-color); font-weight: 500; transition: all 0.2s ease-in-out; }
        .btn-success:hover, .btn-secondary:hover, .btn-outline-primary:hover, .btn-outline-danger:hover { transform: translateY(-2px); }
        .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(0, 90, 156, 0.25); }

        /* Estilos para DataTables */
        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input,
        tfoot input {
            border-radius: 0.375rem; border: 1px solid var(--border-color); padding: 0.375rem 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        .dataTables_wrapper .dataTables_filter input:focus,
        tfoot input:focus {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 0.25rem rgba(0, 90, 156, 0.25);
             outline: none;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: var(--primary-color) !important; border-color: var(--primary-color) !important;
            color: white !important; border-radius: 50% !important;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button { border-radius: 50% !important; margin: 0 2px; }
        #minhaTabela thead, #minhaTabela tfoot { background-color: #f0f2f5; }
        tfoot input { width: 100%; }

        /* Estilo para o painel de upload */
        .upload-panel {
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            background-color: #fcfdff;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1056;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
        }
    </style>
</head>
<body class="d-flex flex-column align-items-center">

<div id="loading-overlay" style="display: none;">
    <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Processando arquivo, por favor aguarde...</p>
</div>


<div class="main-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="page-title text-center mb-0"><i class="bi bi-search"></i> Consulta de Preço</h3>
        <div class="d-flex gap-2">
            <a href="/dia" class="btn btn-outline-primary"><i class="bi bi-calendar-date"></i> Consultas</a>
            <a href="/" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Sair</a>
        </div>
    </div>

    <form id="formConsulta" action="/consulta" method="post" class="mb-5">
        <input type="hidden" name="token" id="mainToken" value="{token}" />
        <div class="row">
            <div class="col-md-6 mb-3"><label for="gtin" class="form-label fw-bold">GTIN/Descrição</label><input type="text" class="form-control" id="gtin" name="gtin" value="8410221110150" required /></div>
            <div class="col-md-6 mb-3"><label for="longitude" class="form-label fw-bold">Longitude</label><input type="number" step="any" class="form-control" id="longitude" name="longitude" required /></div>
            <div class="col-md-6 mb-3"><label for="latitude" class="form-label fw-bold">Latitude</label><input type="number" step="any" class="form-control" id="latitude" name="latitude" required /></div>
            <div class="col-md-6 mb-3"><label for="nroKmDistancia" class="form-label fw-bold">Raio de Distância (Km)</label><input type="number" class="form-control" id="nroKmDistancia" name="nroKmDistancia" value="10" required /></div>
            <div class="col-md-6 mb-3"><label for="nroDiaPrz" class="form-label fw-bold">Prazo (Dias)</label><input type="number" class="form-control" id="nroDiaPrz" name="nroDiaPrz" value="3" required /></div>
        </div>
        <div class="d-flex gap-2 mt-2">
            <button type="submit" class="btn btn-success w-100 py-2"><i class="bi bi-send-fill me-2"></i>Consultar</button>
            <button type="button" id="btnLimpar" class="btn btn-secondary w-100 py-2"><i class="bi bi-eraser-fill me-2"></i>Limpar</button>
        </div>
    </form>

    <div class="upload-panel mb-5">
        <h5 class="text-muted fw-bold mb-3"><i class="bi bi-file-earmark-arrow-up-fill"></i> Consulta em Lote</h5>
        <form id="formUpload" action="/consulta/upload" method="post" enctype="multipart/form-data">
            <input type="hidden" name="token" id="uploadToken" />
            <input type="hidden" name="longitude" id="uploadLongitude" />
            <input type="hidden" name="latitude" id="uploadLatitude" />
            <input type="hidden" name="nroKmDistancia" id="uploadKmDistancia" />
            <input type="hidden" name="nroDiaPrz" id="uploadDiaPrz" />

            <div class="row align-items-end">
                <div class="col-md-8 mb-3 mb-md-0">
                    <label for="fileUpload" class="form-label">Arquivo de GTINs (.txt)</label>
                    <input class="form-control" type="file" id="fileUpload" name="file" accept=".txt" required>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-outline-primary w-100"><i class="bi bi-gear-fill me-2"></i>Processar Arquivo</button>
                </div>
            </div>
        </form>
    </div>

    {#if !itens.isEmpty()}
    <hr>
    <div class="table-responsive mb-4">
        <table id="minhaTabela" class="display table table-striped w-100">
            <thead>
            <tr><th>Descrição</th><th>Loja</th><th>Endereço</th><th>Preço</th></tr>
            </thead>
            <tbody>
            {#for item in itens}
            <tr>
                <td>{item.texDesc}</td>
                <td>{item.nomeContrib}</td>
                <td>{item.nomeLograd}</td>
                <td>{item.vlrItem}</td>
            </tr>
            {/for}
            </tbody>
            <tfoot>
            <tr><th>Descrição</th><th>Loja</th><th>Endereço</th><th>Preço</th></tr>
            </tfoot>
        </table>
    </div>
    {/if}

    {#if itens.isEmpty()}
    <div class="alert alert-info text-center">Nenhum resultado para exibir. Por favor, realize uma consulta.</div>
    {/if}

    <p class="text-center mt-4 text-muted" style="font-size: 0.9rem;">
        Sistema Interno de Busca de Preços
    </p>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
    $(document).ready(function () {
        // --- Lógica do Botão Limpar ---
        $('#btnLimpar').click(function () {
            const token = $('#mainToken').val();
            const form = $('<form>', { method: 'POST', action: '/consulta/limpar' });
            form.append($('<input>', { type: 'hidden', name: 'token', value: token }));
            $('body').append(form);
            form.submit();
        });

        // --- Lógica para o formulário de Upload ---
        $('#formUpload').on('submit', function(event) {
            event.preventDefault();
            $('#loading-overlay').show();

            $('#uploadToken').val($('#mainToken').val());
            $('#uploadLongitude').val($('#longitude').val());
            $('#uploadLatitude').val($('#latitude').val());
            $('#uploadKmDistancia').val($('#nroKmDistancia').val());
            $('#uploadDiaPrz').val($('#nroDiaPrz').val());

            this.submit();
        });

        // Se a tabela não existir, não faz mais nada
        if ($('#minhaTabela').length === 0) {
            return;
        }

        // --- LÓGICA DA TABELA OTIMIZADA ---
        $.fn.dataTable.ext.type.order['brazilian-currency-pre'] = function (d) {
            d = d.replace(/R\$\s?/, '').replace(/\./g, '').replace(/,/, '.');
            return parseFloat(d) || 0;
        };

        $('#minhaTabela tfoot th').each(function () {
            var title = $(this).text();
            $(this).html('<input type="text" placeholder="Buscar ' + title + '..." />');
        });

        var table = $('#minhaTabela').DataTable({
            order: [[3, 'asc']],
            pageLength: 25,
            language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json" },
            columnDefs: [{ type: 'brazilian-currency', targets: 3 }],
            initComplete: function () {
                this.api().columns().every(function () {
                    var that = this;
                    $('input', this.footer()).on('keyup change clear', function () {
                        if (that.search() !== this.value) {
                            that.search(this.value).draw();
                        }
                    });
                });
            }
        });
    });

    // Gerar latitude e longitude
    function gerarVariacao(base, variacao) {
        return (base + (Math.random() * 2 - 1) * variacao).toFixed(7);
    }
    document.addEventListener('DOMContentLoaded', function () {
        if (!document.getElementById('latitude').value) {
             document.getElementById('latitude').value = gerarVariacao(-30.0666644, 0.0004);
        }
        if (!document.getElementById('longitude').value) {
             document.getElementById('longitude').value = gerarVariacao(-51.1070345, 0.0004);
        }
    });
</script>
</body>
</html>