<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Consulta de Preço Comparativa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #005A9C; --success-color: #198754; --secondary-color: #6c757d;
            --background-color: #f4f6f9; --text-color: #333; --card-bg-color: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.08); --border-color: #dee2e6;
        }
        body { background-color: var(--background-color); font-family: 'Poppins', sans-serif; color: var(--text-color); }
        .main-container {
            background-color: var(--card-bg-color); border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color); padding: 2rem;
            margin-top: 1.5rem; width: 100%; max-width: 95%;
        }
        .page-title { color: var(--primary-color); font-weight: 600; display: flex; align-items: center; gap: 0.75rem; }
        .controls-panel { background-color: #fcfdff; border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; }
        .btn-success { background-color: var(--success-color); border-color: var(--success-color); font-weight: 500; transition: all 0.2s ease-in-out; }
        .btn-success:hover, .btn-secondary:hover { transform: translateY(-2px); }
        .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(0, 90, 156, 0.25); }

        /* Estilos para DataTables */
        .dataTables_wrapper .dataTables_length select, .dataTables_wrapper .dataTables_filter input {
            border-radius: 0.375rem; border: 1px solid var(--border-color); padding: 0.375rem 0.75rem;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: var(--primary-color) !important; border-color: var(--primary-color) !important; color: white !important;
        }
        #comparisonTable thead { background-color: #f8f9fa; }
    </style>
</head>
<body class="bg-light d-flex flex-column align-items-center pt-5">
<div class="main-container">
    <h3 class="page-title text-center mb-4"><i class="bi bi-bar-chart-line-fill"></i> Consulta de Preço Comparativa</h3>

    <div class="controls-panel">
        <form id="formConsulta" action="/consulta" method="post">
            <input type="hidden" name="token" value="{token}" />
            <div class="row">
                <div class="col-md-6 mb-3"><label for="gtin" class="form-label fw-bold">GTIN/Descrição</label><input type="text" class="form-control" id="gtin" name="gtin" value="8410221110150" required /></div>
                <div class="col-md-6 mb-3"><label for="longitude" class="form-label fw-bold">Longitude</label><input type="number" step="any" class="form-control" id="longitude" name="longitude" required /></div>
                <div class="col-md-6 mb-3"><label for="latitude" class="form-label fw-bold">Latitude</label><input type="number" step="any" class="form-control" id="latitude" name="latitude" required /></div>
                <div class="col-md-6 mb-3"><label for="nroKmDistancia" class="form-label fw-bold">Raio de Distância (Km)</label><input type="number" class="form-control" id="nroKmDistancia" name="nroKmDistancia" value="10" required /></div>
                <div class="col-md-6 mb-3"><label for="nroDiaPrz" class="form-label fw-bold">Prazo (Dias)</label><input type="number" class="form-control" id="nroDiaPrz" name="nroDiaPrz" value="3" required /></div>
            </div>
            <div class="d-flex gap-2 mt-2">
                <button type="submit" class="btn btn-success w-100 py-2"><i class="bi bi-send-fill me-2"></i>Consultar</button>
                <button type="button" id="btnLimpar" class="btn btn-secondary w-100 py-2"><i class="bi bi-eraser-fill me-2"></i>Limpar</button>
            </div>
        </form>
    </div>

    <div style="display: none;">
        <table id="sourceTable">
            <tbody>
            {#for item in itens}
            <tr>
                <td>{item.texDesc}</td>
                <td>{item.nomeContrib}</td>
                <td>{item.nomeLograd}</td>
                <td>{item.vlrItem}</td>
            </tr>
            {/for}
            </tbody>
        </table>
    </div>

    {#if !itens.isEmpty()}
    <div id="comparisonTableContainer">
    </div>
    {/if}

    {#if itens.isEmpty()}
    <div class="alert alert-info text-center">Nenhum resultado para exibir. Por favor, realize uma consulta.</div>
    {/if}


    <p class="text-center mt-4 text-muted" style="font-size: 0.9rem;">Sistema Interno de Busca de Preços</p>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>

<script>
    $(document).ready(function () {
        // Se a tabela de fonte de dados não tiver linhas, não faz nada
        if ($('#sourceTable tbody tr').length === 0) {
            return;
        }

        // 1. Extrair os dados da tabela escondida
        let rawData = [];
        $('#sourceTable tbody tr').each(function() {
            const row = $(this).find('td');
            rawData.push({
                descricao: row.eq(0).text(),
                loja: row.eq(1).text(),
                preco: row.eq(3).text()
            });
        });

        // 2. Processar os dados para o formato de comparação
        var products = {};
        var allStores = new Set();
        rawData.forEach(function(item) {
            if (!products[item.descricao]) {
                products[item.descricao] = {};
            }
            products[item.descricao][item.loja] = item.preco;
            allStores.add(item.loja);
        });

        // 3. FILTRAR: Manter apenas as colunas (lojas) que têm pelo menos um preço
        var storesWithData = new Set();
        Object.values(products).forEach(function(storePrices) {
            Object.keys(storePrices).forEach(function(storeName) {
                storesWithData.add(storeName);
            });
        });
        var finalStoreList = Array.from(storesWithData).sort();

        // 4. Construir o HTML da tabela final APENAS com as colunas que têm dados
        var tableHtml = '<div class="alert alert-info"><i class="bi bi-info-circle-fill"></i> Apenas lojas com preços para os produtos consultados são exibidas. Rolagem horizontal pode ser necessária.</div>' +
            '<div class="table-responsive mb-4"><table id="comparisonTable" class="display table table-striped w-100"><thead><tr><th>Descrição</th>';
        finalStoreList.forEach(function(store) {
            tableHtml += '<th>' + store + '</th>';
        });
        tableHtml += '</tr></thead><tbody>';
        var productNames = Object.keys(products).sort();
        productNames.forEach(function(productName) {
            tableHtml += '<tr><td>' + productName + '</td>';
            finalStoreList.forEach(function(store) {
                var price = products[productName][store] || '';
                tableHtml += '<td>' + price + '</td>';
            });
            tableHtml += '</tr>';
        });
        tableHtml += '</tbody></table></div>';

        // 5. Inserir a tabela no container e inicializar o DataTables
        $('#comparisonTableContainer').html(tableHtml);

        var comparisonTableApi = $('#comparisonTable').DataTable({
            scrollX: true,
            fixedColumns: { left: 1 },
            pageLength: 50,
            language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json" }
        });

        // --- Lógica dos Botões e Formulário ---
        $('#btnLimpar').click(function () {
            const token = $('input[name="token"]').val();
            const form = $('<form>', { method: 'POST', action: '/consulta/limpar' });
            form.append($('<input>', { type: 'hidden', name: 'token', value: token }));
            $('body').append(form);
            form.submit();
        });
    });

    // Gerar latitude e longitude (sem alterações)
    function gerarVariacao(base, variacao) { return (base + (Math.random() * 2 - 1) * variacao).toFixed(7); }
    document.addEventListener('DOMContentLoaded', function () {
        if (!document.getElementById('latitude').value) {
             document.getElementById('latitude').value = gerarVariacao(-30.0666644, 0.0004);
        }
        if (!document.getElementById('longitude').value) {
             document.getElementById('longitude').value = gerarVariacao(-51.1070345, 0.0004);
        }
    });
</script>
</body>
</html>